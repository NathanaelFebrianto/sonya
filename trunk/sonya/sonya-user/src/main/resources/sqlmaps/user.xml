<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="user">
    <typeAlias alias="user" type="com.sonya.user.model.User"/>
    <typeAlias alias="role" type="com.sonya.user.model.Role"/>

    <resultMap id="userResult" class="user">
        <result property="id" column="id"/>
        <result property="sid" column="sid"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>   
        <result property="firstName" column="first_name"/>
        <result property="lastName" column="last_name"/>        
        <result property="country" column="country"/>
        <result property="timeZone" column="time_zone"/>
        <result property="company" column="company"/>
        <result property="department" column="department"/>
        <result property="jobPosition" column="job_position"/>
        <result property="postalCode" column="postal_code"/>
        <result property="address" column="address"/>
        <result property="addressDetail" column="address_detail"/>
        <result property="email" column="email"/>
        <result property="phoneNumber" column="phone_no"/>
        <result property="mobileNumber" column="mobile_no"/>
        <result property="website" column="website"/>
        <result property="enabled" column="enabled"/>
        <result property="use" column="use_yn"/>
        <result property="terminate" column="terminate_yn"/>
        <result property="terminateDate" column="terminate_date"/>
        <result property="insertDate" column="insert_date"/>
        <result property="updateDate" column="update_date"/>
        <result property="deleteDate" column="delete_date"/>
    </resultMap>
    
    <resultMap id="roleResult" class="role">
        <result property="sid" column="sid"/>
        <result property="id" column="role_id"/>
        <result property="name" column="role_name"/>
        <result property="description" column="role_description"/>
    </resultMap>

    <select id="getUsers" resultMap="userResult">
    <![CDATA[
        select * from t_user order by upper(username)
    ]]>
    </select>
    
    <select id="getUser" resultMap="userResult">
    <![CDATA[
        select * from t_user where id=#id#
    ]]>
    </select>
    
    <select id="getUserRoles" resultMap="roleResult">
    <![CDATA[
        select ur.sid, r.role_id, r.role_name, r.role_description from t_role r, t_user_role ur
        where (ur.role_id = r.role_id) and ur.user_id=#id#
    ]]>
    </select>

    <select id="getUserByUsername" resultMap="userResult">
    <![CDATA[
        select * from t_user where username=#username#
    ]]>
    </select>
    
	<select id="getUserPassword" resultClass="java.lang.String">
    <![CDATA[
        select password from t_user where username=#username#
    ]]>
    </select>
    
    <insert id="addUser" parameterClass="user">
    <![CDATA[
        insert into
        t_user (sid, username, password, first_name, last_name, 
	        country, time_zone, company, department, job_position,
	        postal_code, address, address_detail, email, phone_no, mobile_no, 
	        website, enabled, use_yn, terminate_yn, terminate_date, 
	        insert_date, update_date, delete_date)
        values (#sid#, #username#, #password#, #firstName#, #lastName#, 
	        #country#, #timeZone#, #company#, #department#, #jobPosition#,
	        #postalCode#, #address#, #addressDetail#, #email#, #phoneNumber#, #mobileNumber#, 
	        #website#, #enabled#, #use#, #terminate#, #terminateDate#, 
	        #insertDate#, #updateDate#, #deleteDate#)
    ]]>
        <selectKey resultClass="java.lang.String" keyProperty="id" type="post">
            select last_insert_id();
        </selectKey>
    </insert>  
    
    <insert id="addUserRole" parameterClass="map">
    <![CDATA[
        insert into t_user_role (sid, user_id, role_id) values (#sid#, #userId#, #roleId#)
    ]]>
    </insert>  

    <update id="updateUser" parameterClass="user">
    <![CDATA[
        update t_user set
            sid = #sid#,
            username = #username#,
            password = #password#,
            first_name = #firstName#,
            last_name = #lastName#,
            country = #country#, 
            time_zone = #timeZone#,
            company = #company#,
            department = #department#,
            job_position = #jobPosition#,
            postal_code = #postalCode#,
            address = #address#,
            address_detail = #addressDetail#,
            email = #email#,
            phone_no = #phoneNumber#,
            mobile_no = #mobileNumber#,
            website = #website#,
            enabled = #enabled#,
            use_yn = #use#,
            terminate_yn = #terminate#,
            terminate_date = #terminateDate#,
            update_date = #updateDate#,
            delete_date = #deleteDate#,
        where id = #id#
    ]]>
    </update>
    
    <delete id="deleteUser" parameterClass="java.lang.String">
    <![CDATA[
        delete from t_user where id = #id#
    ]]>
    </delete>
    
    <delete id="deleteUserRoles" parameterClass="java.lang.Long">
    <![CDATA[
        delete from t_user_role where user_id = #id#
    ]]>
    </delete>
    
</sqlMap>