<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" 
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="org.firebird.io.dao.TopicUserClusterMapper">

	<resultMap id="topicUserClusterResultMap" type="org.firebird.io.model.TopicUserCluster">
		<id property="topicId" column="topic_id" />
		<result property="websiteId" column="website_id" />
		<result property="topicId" column="topic_id" />
		<result property="userId" column="user_id" />
		<result property="vertexId" column="vertex_id" />
		<result property="userName" column="user_name" />
		<result property="userProfileImage" column="image_file" />
		<result property="userUrl" column="user_url" />
		<result property="topicUser" column="is_topic_user" />
		<result property="cluster" column="cluster" />
		<result property="score" column="score" />
		<result property="createDate" column="create_date" />
		<result property="lastUpdateDate" column="last_update_date" />
	</resultMap>	

	<select id="selectUsers" parameterType="org.firebird.io.model.TopicUserCluster" resultMap="topicUserClusterResultMap">
		SELECT a.*, b.vertex_id, b.user_name, b.image_file, b.user_url
		FROM topic_user_cluster a, vertex b
		WHERE a.website_id = b.website_id AND 
			a.user_id = b.vertex_id AND 
			a.website_id = #{websiteId} AND 
			a.topic_id = #{topicId}
		ORDER BY a.score DESC
		<if test="topUserNum != null">
			LIMIT #{topUserNum}
		</if>
	</select>

	<insert id="insertUser" parameterType="org.firebird.io.model.TopicUserCluster">
		INSERT INTO topic_user_cluster (
			  website_id
			, topic_id
			, user_id
			, is_topic_user
			, cluster
			, score
			, create_date
			, last_update_date 
		)
		VALUES (
			  #{websiteId,javaType=int,jdbcType=NUMERIC}
			, #{topicId,javaType=int,jdbcType=NUMERIC}
			, #{userId,jdbcType=VARCHAR}
			, #{topicUser,javaType=boolean,jdbcType=BOOLEAN}
			, #{cluster,javaType=int,jdbcType=NUMERIC}
			, #{score,javaType=float,jdbcType=FLOAT}
			, NOW()
			, NOW()	
		)
	</insert>

	<delete id="deleteUsers" parameterType="int">
		DELETE FROM topic_user_cluster
		WHERE website_id = #{websiteId}
	</delete>

</mapper>